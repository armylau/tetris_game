# 俄罗斯方块游戏重构方案 v0.2

## 1. 重构概述

### 1.1 重构目标
将当前的`tetris_main.py`单文件架构重构为模块化、可维护的代码结构，提升代码质量、可读性和可扩展性。

### 1.2 重构原则
- **单一职责原则**：每个类只负责一个功能
- **开闭原则**：对扩展开放，对修改封闭
- **依赖倒置**：依赖抽象而非具体实现
- **模块化设计**：清晰的模块边界和接口

## 2. 当前问题分析

### 2.1 代码结构问题
- **单文件过大**：786行代码集中在一个文件中
- **职责混乱**：游戏逻辑、渲染、输入处理混合在一起
- **耦合度高**：各组件之间直接依赖，难以测试和维护
- **可扩展性差**：添加新功能需要修改核心文件

### 2.2 具体问题
1. **Piece类**：方块逻辑与游戏状态耦合
2. **Board类**：游戏板逻辑与渲染逻辑混合
3. **GameState类**：状态管理与业务逻辑混合
4. **Renderer类**：渲染逻辑与UI逻辑混合
5. **TetrisGame类**：游戏循环与业务逻辑混合

## 3. 重构架构设计

### 3.1 新的项目结构

```
src/
├── core/                    # 核心游戏逻辑
│   ├── __init__.py
│   ├── piece.py            # 方块类
│   ├── board.py            # 游戏板类
│   ├── game_state.py       # 游戏状态管理
│   ├── collision.py        # 碰撞检测
│   └── game_engine.py      # 游戏引擎
├── ui/                     # 用户界面
│   ├── __init__.py
│   ├── renderer.py         # 渲染引擎
│   ├── hud.py             # 游戏界面元素
│   ├── menu.py            # 菜单系统
│   └── input_handler.py    # 输入处理
├── audio/                  # 音频系统
│   ├── __init__.py
│   ├── voice_manager.py    # 音效管理器
│   ├── voice_player.py     # 音效播放器
│   ├── bgm_player.py       # 背景音乐播放器
│   └── volume_controller.py # 音量控制器
├── config/                 # 配置管理
│   ├── __init__.py
│   ├── game_config.py      # 游戏配置
│   ├── voice_config.py     # 音效配置
│   └── level_config.py     # 关卡配置
├── utils/                  # 工具类
│   ├── __init__.py
│   ├── constants.py        # 常量定义
│   ├── helpers.py          # 工具函数
│   └── font_utils.py       # 字体工具
├── level/                  # 关卡系统
│   ├── __init__.py
│   ├── level_manager.py    # 关卡管理器
│   ├── level_selector.py   # 关卡选择器
│   └── level_progress.py   # 关卡进度
└── main.py                 # 主入口文件
```

### 3.2 核心模块设计

#### 3.2.1 Core模块（核心游戏逻辑）

**piece.py** - 方块类重构
```python
class Piece:
    """方块类 - 负责方块形状和旋转逻辑"""
    
    def __init__(self, piece_type: str):
        self.type = piece_type
        self.rotation = 0
        self.shape = self._get_shape()
        self.color = self._get_color()
    
    def rotate(self) -> bool:
        """旋转方块"""
        pass
    
    def get_shape(self) -> List[List[int]]:
        """获取当前形状"""
        pass
    
    def get_dimensions(self) -> Tuple[int, int]:
        """获取方块尺寸"""
        pass
    
    def _get_shape(self) -> List[List[int]]:
        """获取形状数据"""
        pass
    
    def _get_color(self) -> Tuple[int, int, int]:
        """获取颜色"""
        pass
```

**board.py** - 游戏板类重构
```python
class Board:
    """游戏板类 - 负责方块放置和行消除"""
    
    def __init__(self, width: int, height: int):
        self.width = width
        self.height = height
        self.grid = self._create_empty_grid()
    
    def is_valid_position(self, piece: Piece, x: int, y: int) -> bool:
        """检查位置是否有效"""
        pass
    
    def place_piece(self, piece: Piece, x: int, y: int) -> bool:
        """放置方块"""
        pass
    
    def clear_lines(self) -> int:
        """清除完整行"""
        pass
    
    def is_game_over(self) -> bool:
        """检查游戏是否结束"""
        pass
    
    def _create_empty_grid(self) -> List[List[Optional[Tuple[int, int, int]]]]:
        """创建空网格"""
        pass
```

**game_state.py** - 游戏状态管理重构
```python
class GameState:
    """游戏状态管理类 - 负责游戏状态和分数管理"""
    
    def __init__(self):
        self.score = 0
        self.level = 1
        self.lines_cleared = 0
        self.game_over = False
        self.paused = False
        self.current_piece: Optional[Piece] = None
        self.next_piece: Optional[Piece] = None
        self.piece_position = (0, 0)
        self.drop_delay = 1000
    
    def update_score(self, lines_cleared: int):
        """更新分数"""
        pass
    
    def update_level(self):
        """更新等级"""
        pass
    
    def spawn_piece(self, piece_type: str):
        """生成新方块"""
        pass
    
    def reset(self):
        """重置游戏状态"""
        pass
```

**game_engine.py** - 游戏引擎重构
```python
class GameEngine:
    """游戏引擎 - 负责游戏主循环和逻辑协调"""
    
    def __init__(self, config: GameConfig):
        self.config = config
        self.board = Board(config.BOARD_WIDTH, config.BOARD_HEIGHT)
        self.game_state = GameState()
        self.collision_detector = CollisionDetector()
        self.last_drop_time = time.time()
    
    def update(self, delta_time: float):
        """更新游戏状态"""
        pass
    
    def handle_piece_movement(self, dx: int, dy: int) -> bool:
        """处理方块移动"""
        pass
    
    def handle_piece_rotation(self) -> bool:
        """处理方块旋转"""
        pass
    
    def drop_piece(self):
        """方块下落"""
        pass
    
    def place_current_piece(self):
        """放置当前方块"""
        pass
```

#### 3.2.2 UI模块（用户界面）

**renderer.py** - 渲染引擎重构
```python
class Renderer:
    """渲染引擎 - 负责游戏画面渲染"""
    
    def __init__(self, screen: pygame.Surface, config: GameConfig):
        self.screen = screen
        self.config = config
        self.font_manager = FontManager()
    
    def render_board(self, board: Board):
        """渲染游戏板"""
        pass
    
    def render_piece(self, piece: Piece, position: Tuple[int, int]):
        """渲染方块"""
        pass
    
    def render_ui(self, game_state: GameState):
        """渲染用户界面"""
        pass
    
    def render_menu(self, menu_state: MenuState):
        """渲染菜单"""
        pass
```

**input_handler.py** - 输入处理重构
```python
class InputHandler:
    """输入处理器 - 负责用户输入处理"""
    
    def __init__(self, config: GameConfig):
        self.config = config
        self.keys_pressed = set()
        self.last_key_time = {}
        self.key_repeat_delay = config.KEY_REPEAT_DELAY
        self.key_repeat_interval = config.KEY_REPEAT_INTERVAL
    
    def handle_events(self) -> List[GameEvent]:
        """处理输入事件"""
        pass
    
    def handle_continuous_input(self, current_time: float) -> List[GameEvent]:
        """处理连续输入"""
        pass
    
    def is_key_pressed(self, key: int) -> bool:
        """检查按键状态"""
        pass
```

#### 3.2.3 Audio模块（音频系统）

**voice_manager.py** - 音效管理器
```python
class VoiceManager:
    """音效管理器 - 统一管理所有音效"""
    
    def __init__(self, config: VoiceConfig):
        self.config = config
        self.voice_player = VoicePlayer()
        self.bgm_player = BGMPlayer()
        self.volume_controller = VolumeController()
    
    def play_effect(self, effect_name: str):
        """播放音效"""
        pass
    
    def play_bgm(self, bgm_name: str):
        """播放背景音乐"""
        pass
    
    def set_volume(self, volume_type: str, volume: float):
        """设置音量"""
        pass
    
    def toggle_mute(self, mute_type: str):
        """切换静音"""
        pass
```

#### 3.2.4 Config模块（配置管理）

**game_config.py** - 游戏配置重构
```python
class GameConfig:
    """游戏配置类 - 集中管理游戏配置"""
    
    # 屏幕配置
    SCREEN_WIDTH = 800
    SCREEN_HEIGHT = 600
    
    # 游戏板配置
    BOARD_WIDTH = 10
    BOARD_HEIGHT = 20
    CELL_SIZE = 30
    BOARD_X = 200
    BOARD_Y = 50
    
    # 游戏参数
    TARGET_FPS = 60
    KEY_REPEAT_DELAY = 200
    KEY_REPEAT_INTERVAL = 50
    DOWN_KEY_HOLD_DELAY = 100
    DOWN_KEY_ACCELERATION_START = 500
    DOWN_KEY_ACCELERATION_MAX = 2000
    DOWN_KEY_MIN_INTERVAL = 50
    DOWN_KEY_MAX_INTERVAL = 200
    
    @classmethod
    def get_score(cls, lines_cleared: int, level: int) -> int:
        """计算分数"""
        pass
    
    @classmethod
    def get_level(cls, lines_cleared: int) -> int:
        """计算等级"""
        pass
    
    @classmethod
    def get_drop_delay(cls, level: int) -> int:
        """计算下落延迟"""
        pass
```

## 4. 重构实施计划

### 4.1 阶段一：基础架构搭建（1-2天）

#### 4.1.1 创建目录结构
```bash
mkdir -p src/{core,ui,audio,config,utils,level}
touch src/{core,ui,audio,config,utils,level}/__init__.py
```

#### 4.1.2 迁移常量定义
- 将颜色定义迁移到`utils/constants.py`
- 将方块形状定义迁移到`core/piece.py`
- 将配置参数迁移到`config/game_config.py`

#### 4.1.3 创建基础接口
- 定义`GameEvent`事件类
- 定义`MenuState`菜单状态类
- 创建基础抽象类

### 4.2 阶段二：核心模块重构（2-3天）

#### 4.2.1 Piece类重构
- 提取方块逻辑到`core/piece.py`
- 优化旋转算法
- 添加形状验证

#### 4.2.2 Board类重构
- 提取游戏板逻辑到`core/board.py`
- 优化行消除算法
- 添加边界检查

#### 4.2.3 GameState类重构
- 提取状态管理到`core/game_state.py`
- 优化状态转换逻辑
- 添加状态验证

#### 4.2.4 GameEngine类创建
- 创建游戏引擎类
- 协调各组件交互
- 实现游戏主循环逻辑

### 4.3 阶段三：UI模块重构（2-3天）

#### 4.3.1 Renderer类重构
- 提取渲染逻辑到`ui/renderer.py`
- 优化渲染性能
- 添加渲染缓存

#### 4.3.2 InputHandler类创建
- 创建输入处理类
- 优化按键处理逻辑
- 添加输入事件系统

#### 4.3.3 HUD类创建
- 创建游戏界面元素类
- 分离UI渲染逻辑
- 优化界面布局

### 4.4 阶段四：音频系统集成（1-2天）

#### 4.4.1 音频模块创建
- 创建`audio/voice_manager.py`
- 创建`audio/voice_player.py`
- 创建`audio/bgm_player.py`
- 创建`audio/volume_controller.py`

#### 4.4.2 音效集成
- 集成音效播放到游戏逻辑
- 添加音效配置管理
- 实现音量控制功能

### 4.5 阶段五：配置和工具模块（1天）

#### 4.5.1 配置模块
- 创建`config/game_config.py`
- 创建`config/voice_config.py`
- 创建`config/level_config.py`

#### 4.5.2 工具模块
- 创建`utils/constants.py`
- 创建`utils/helpers.py`
- 优化`utils/font_utils.py`

### 4.6 阶段六：主入口重构（1天）

#### 4.6.1 主文件重构
- 重构`main.py`为简洁的入口文件
- 移除重复代码
- 优化模块导入

#### 4.6.2 测试和调试
- 全面测试重构后的功能
- 修复发现的问题
- 优化性能

## 5. 重构后的优势

### 5.1 代码质量提升
- **可读性**：每个文件职责单一，代码更易理解
- **可维护性**：模块化设计，修改影响范围小
- **可测试性**：各模块独立，便于单元测试

### 5.2 扩展性增强
- **新功能添加**：新功能可以独立模块实现
- **插件化**：可以轻松添加新的渲染器、音效系统等
- **配置化**：游戏参数可以通过配置文件调整

### 5.3 性能优化
- **渲染优化**：独立的渲染模块可以优化渲染性能
- **内存管理**：模块化设计便于内存管理优化
- **加载优化**：按需加载模块，减少启动时间

## 6. 迁移策略

### 6.1 渐进式迁移
1. **保持兼容性**：重构过程中保持原有功能正常
2. **分步迁移**：一个模块一个模块地迁移
3. **充分测试**：每个阶段都要充分测试

### 6.2 测试策略
1. **单元测试**：为每个模块编写单元测试
2. **集成测试**：测试模块间的交互
3. **回归测试**：确保原有功能不受影响

### 6.3 文档更新
1. **API文档**：更新各模块的API文档
2. **使用说明**：更新开发和使用说明
3. **架构文档**：更新项目架构文档

## 7. 风险评估

### 7.1 技术风险
- **重构复杂度**：大规模重构可能引入新bug
- **性能影响**：模块化可能影响性能
- **兼容性问题**：可能影响现有功能

### 7.2 缓解措施
- **充分测试**：每个阶段都要充分测试
- **性能监控**：监控重构后的性能表现
- **回滚计划**：准备回滚到原版本的计划

## 8. 后续规划

### 8.1 短期目标（1-2周）
- 完成基础架构搭建
- 完成核心模块重构
- 完成UI模块重构

### 8.2 中期目标（1个月）
- 完成音频系统集成
- 完成配置系统优化
- 完成测试覆盖

### 8.3 长期目标（2-3个月）
- 添加新功能模块
- 优化性能表现
- 完善文档体系

---

*文档版本：v0.2*  
*创建日期：2024年*  
*最后更新：2024年*
