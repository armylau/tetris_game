# 俄罗斯方块关卡系统需求文档

## 1. 项目概述

### 1.1 项目名称
俄罗斯方块游戏关卡系统

### 1.2 项目目标
为现有的俄罗斯方块游戏增加关卡系统，通过不同关卡的难度递增，提升游戏的挑战性和可玩性。

### 1.3 项目背景
当前游戏只有基于消除行数的等级系统，缺乏明确的关卡概念。通过引入关卡系统，可以为玩家提供更清晰的游戏进度和目标。

## 2. 功能需求

### 2.1 关卡定义

#### 2.1.1 关卡结构
- **关卡数量**：设计20个关卡
- **关卡类型**：
  - 普通关卡（1-15关）：逐步增加难度
  - 挑战关卡（16-18关）：特殊挑战模式
  - 终极关卡（19-20关）：极限挑战

#### 2.1.2 关卡属性
每个关卡包含以下属性：
```python
class Level:
    level_id: int              # 关卡编号
    name: str                  # 关卡名称
    description: str           # 关卡描述
    target_lines: int          # 目标消除行数
    time_limit: int           # 时间限制（秒，可选）
    speed_multiplier: float   # 速度倍数
    piece_types: List[str]    # 允许的方块类型
    special_rules: Dict       # 特殊规则
    unlock_condition: str     # 解锁条件
```

### 2.2 难度递增机制

#### 2.2.1 速度递增
- **基础速度**：每关基础下落速度递增
- **加速倍数**：每关的加速倍数递增
- **最大速度**：设置合理的最大速度限制

#### 2.2.2 方块类型限制
- **关卡1-5**：所有方块类型
- **关卡6-10**：随机禁用1-2种方块类型
- **关卡11-15**：只允许特定方块类型
- **关卡16-20**：特殊方块组合

#### 2.2.3 特殊规则
- **关卡7**：只能旋转一次
- **关卡10**：不能使用向下键加速
- **关卡13**：必须消除特定行数才能过关
- **关卡16**：时间限制模式
- **关卡18**：反向控制模式
- **关卡20**：终极挑战模式

### 2.3 关卡进度系统

#### 2.3.1 解锁机制
- **线性解锁**：完成前一关才能解锁下一关
- **星级解锁**：获得足够星级解锁特殊关卡
- **成就解锁**：完成特定成就解锁隐藏关卡

#### 2.3.2 星级评价
每个关卡设置3星评价系统：
- **1星**：完成基本目标
- **2星**：完成目标 + 额外要求
- **3星**：完美完成 + 特殊成就

#### 2.3.3 进度保存
- 保存每关的最高分
- 保存每关的星级评价
- 保存总体游戏进度

### 2.4 用户界面

#### 2.4.1 关卡选择界面
- **关卡网格**：显示所有关卡
- **关卡状态**：已解锁/未解锁/已完成
- **星级显示**：显示每关获得的星级
- **关卡信息**：显示关卡名称和描述

#### 2.4.2 游戏界面增强
- **关卡显示**：显示当前关卡信息
- **目标显示**：显示关卡目标
- **进度条**：显示完成进度
- **时间显示**：显示剩余时间（如果有）

#### 2.4.3 结算界面
- **关卡结果**：显示是否通关
- **星级评价**：显示获得的星级
- **详细统计**：显示详细游戏数据
- **下一关按钮**：直接进入下一关

## 3. 技术需求

### 3.1 数据结构

#### 3.1.1 关卡配置
```python
LEVEL_CONFIG = {
    1: {
        "name": "新手入门",
        "description": "学习基本操作",
        "target_lines": 5,
        "speed_multiplier": 1.0,
        "piece_types": ["I", "O", "T", "S", "Z", "J", "L"],
        "special_rules": {},
        "unlock_condition": "none"
    },
    # ... 更多关卡配置
}
```

#### 3.1.2 游戏状态扩展
```python
class GameState:
    def __init__(self):
        # 现有属性
        self.score = 0
        self.level = 1
        self.lines_cleared = 0
        
        # 新增关卡相关属性
        self.current_level_id = 1
        self.level_progress = {}  # 关卡进度
        self.level_scores = {}    # 关卡分数
        self.level_stars = {}     # 关卡星级
        self.game_mode = "level"  # 游戏模式
```

### 3.2 核心功能

#### 3.2.1 关卡管理器
```python
class LevelManager:
    def __init__(self):
        self.levels = LEVEL_CONFIG
        self.current_level = None
    
    def load_level(self, level_id: int) -> bool:
        """加载指定关卡"""
        pass
    
    def check_level_complete(self, game_state: GameState) -> bool:
        """检查关卡是否完成"""
        pass
    
    def calculate_stars(self, game_state: GameState) -> int:
        """计算星级评价"""
        pass
```

#### 3.2.2 特殊规则处理器
```python
class SpecialRuleHandler:
    def __init__(self):
        self.active_rules = {}
    
    def apply_rules(self, game_state: GameState):
        """应用特殊规则"""
        pass
    
    def check_rule_violation(self, action: str) -> bool:
        """检查是否违反规则"""
        pass
```

### 3.3 界面组件

#### 3.3.1 关卡选择器
```python
class LevelSelector:
    def __init__(self, screen: pygame.Surface):
        self.screen = screen
        self.levels = LEVEL_CONFIG
    
    def render(self):
        """渲染关卡选择界面"""
        pass
    
    def handle_input(self, event) -> Optional[int]:
        """处理输入，返回选择的关卡ID"""
        pass
```

#### 3.3.2 关卡信息显示
```python
class LevelInfoDisplay:
    def __init__(self, screen: pygame.Surface):
        self.screen = screen
    
    def render_level_info(self, level_data: Dict):
        """渲染关卡信息"""
        pass
    
    def render_progress(self, game_state: GameState):
        """渲染进度信息"""
        pass
```

## 4. 实现计划

### 4.1 第一阶段：基础关卡系统
- [ ] 创建关卡配置数据结构
- [ ] 实现关卡管理器
- [ ] 修改游戏状态管理
- [ ] 实现关卡选择界面

### 4.2 第二阶段：难度递增
- [ ] 实现速度递增机制
- [ ] 实现方块类型限制
- [ ] 实现基础特殊规则
- [ ] 测试难度平衡

### 4.3 第三阶段：高级功能
- [ ] 实现星级评价系统
- [ ] 实现进度保存功能
- [ ] 实现高级特殊规则
- [ ] 完善用户界面

### 4.4 第四阶段：优化和测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 全面测试
- [ ] 文档完善

## 5. 验收标准

### 5.1 功能验收
- [ ] 能够正确加载和运行所有关卡
- [ ] 难度递增机制正常工作
- [ ] 特殊规则正确应用
- [ ] 星级评价系统准确

### 5.2 性能验收
- [ ] 游戏运行流畅，无卡顿
- [ ] 内存使用合理
- [ ] 加载时间短

### 5.3 用户体验验收
- [ ] 界面直观易用
- [ ] 操作响应及时
- [ ] 反馈信息清晰

## 6. 风险评估

### 6.1 技术风险
- **复杂度增加**：关卡系统可能增加代码复杂度
- **性能影响**：特殊规则可能影响游戏性能
- **兼容性问题**：新功能可能与现有功能冲突

### 6.2 缓解措施
- **模块化设计**：将关卡系统设计为独立模块
- **性能测试**：定期进行性能测试
- **渐进式开发**：分阶段实现功能

## 7. 维护计划

### 7.1 代码维护
- 定期代码审查
- 性能监控
- 错误日志分析

### 7.2 内容更新
- 定期添加新关卡
- 调整难度平衡
- 优化用户体验

## 8. 总结

本需求文档定义了俄罗斯方块游戏关卡系统的完整功能需求。通过实现这个系统，将为游戏增加更多的挑战性和可玩性，提升玩家的游戏体验。系统设计考虑了技术可行性、用户体验和可维护性，为后续开发提供了清晰的指导。
